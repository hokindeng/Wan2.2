graph TD
    Start["User runs: python generate.py --task ti2v-5B"] --> Parse["Parse arguments"]
    Parse --> CreatePipe["Create WanTI2V pipeline"]
    
    CreatePipe --> LoadT5["Load T5 encoder"]
    CreatePipe --> LoadVAE["Load Wan2.2 VAE"]
    CreatePipe --> LoadDiT["Load 5B DiT model"]
    
    LoadDiT --> ConfigModel["Configure model:<br/>eval mode, dtype bf16"]
    
    Parse --> CheckImage{"Image<br/>provided?"}
    CheckImage -->|Yes| I2VFlow["I2V mode"]
    CheckImage -->|No| T2VFlow["T2V mode"]
    
    I2VFlow --> PrepImage["Preprocess image:<br/>resize, crop, normalize"]
    T2VFlow --> CalcShape["Calculate latent shape"]
    
    PrepImage --> EncodeImage["VAE encode image"]
    CalcShape --> InitNoise["Initialize random noise"]
    
    EncodeImage --> TextEncode["Encode text prompt<br/>with T5"]
    InitNoise --> TextEncode
    
    TextEncode --> SetupScheduler["Setup scheduler:<br/>UniPC or DPM++"]
    
    SetupScheduler --> DenoisingLoop["Denoising loop"]
    
    DenoisingLoop --> ForwardCond["Forward pass: conditional"]
    ForwardCond --> ForwardUncond["Forward pass: unconditional"]
    ForwardUncond --> CFG["Apply classifier-free guidance"]
    CFG --> SchedulerStep["Scheduler step"]
    SchedulerStep --> CheckDone{"More<br/>steps?"}
    CheckDone -->|Yes| DenoisingLoop
    CheckDone -->|No| DecodeVAE["VAE decode to video"]
    
    DecodeVAE --> SaveVideo["Save as MP4"]
    SaveVideo --> End["Done"]

    style Start fill:#e1f5ff
    style End fill:#c8e6c9
    style CheckImage fill:#fff9c4
    style CheckDone fill:#fff9c4
    style DenoisingLoop fill:#ffe0b2
    style DecodeVAE fill:#f8bbd0
