%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#1a1a2e', 'primaryTextColor': '#ffffff', 'primaryBorderColor': '#7b2cbf', 'lineColor': '#9d4edd', 'secondaryColor': '#240046', 'tertiaryColor': '#3c096c'}}}%%

graph TB
    subgraph ROOT["­ЪЊЂ Project Root"]
        GENERATE["<b>generate.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>Main entry point<br/>CLI argument parsing<br/>Task routing"]
    end

    subgraph WAN["­ЪЊд wan/ Package"]
        INIT["<b>__init__.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>Exports:<br/>Рђб WanT2V<br/>Рђб WanI2V<br/>Рђб WanTI2V<br/>Рђб WanS2V<br/>Рђб WanAnimate"]
    end

    subgraph PIPELINES["­Ъјг Pipeline Modules"]
        T2V["<b>text2video.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>class WanT2V<br/>Рђб __init__()<br/>Рђб _configure_model()<br/>Рђб _prepare_model_for_timestep()<br/>Рђб generate()"]
        
        I2V["<b>image2video.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>class WanI2V<br/>Рђб Image preprocessing<br/>Рђб Mask generation<br/>Рђб First-frame conditioning"]
        
        TI2V["<b>textimage2video.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>class WanTI2V<br/>Рђб 5B model (no MoE)<br/>Рђб Text+Image fusion"]
        
        S2V["<b>speech2video.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>class WanS2V<br/>Рђб Audio encoding<br/>Рђб Multi-clip generation<br/>Рђб TTS integration"]
        
        ANIMATE["<b>animate.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>class WanAnimate<br/>Рђб Pose preprocessing<br/>Рђб Motion transfer<br/>Рђб Face encoding"]
    end

    subgraph CONFIGS["РџЎ№ИЈ wan/configs/"]
        CFG_INIT["<b>__init__.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>WAN_CONFIGS dict<br/>SIZE_CONFIGS<br/>SUPPORTED_SIZES"]
        
        CFG_SHARED["<b>shared_config.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>wan_shared_cfg<br/>Рђб t5_model<br/>Рђб param_dtype<br/>Рђб sample_fps"]
        
        CFG_T2V["<b>wan_t2v_A14B.py</b>"]
        CFG_I2V["<b>wan_i2v_A14B.py</b>"]
        CFG_TI2V["<b>wan_ti2v_5B.py</b>"]
        CFG_S2V["<b>wan_s2v_14B.py</b>"]
        CFG_ANIM["<b>wan_animate_14B.py</b>"]
    end

    subgraph MODULES["­ЪДа wan/modules/"]
        MOD_INIT["<b>__init__.py</b>"]
        
        MODEL["<b>model.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>class WanModel(ModelMixin, ConfigMixin)<br/>Рђб sinusoidal_embedding_1d()<br/>Рђб rope_params(), rope_apply()<br/>Рђб WanRMSNorm, WanLayerNorm<br/>Рђб WanSelfAttention<br/>Рђб WanCrossAttention<br/>Рђб WanAttentionBlock<br/>Рђб Head<br/>Рђб forward(), unpatchify()"]
        
        ATTENTION["<b>attention.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>flash_attention()<br/>Рђб PyTorch SDPA<br/>Рђб Flash Attention 2"]
        
        T5["<b>t5.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>class T5EncoderModel<br/>Рђб T5Encoder<br/>Рђб T5Attention<br/>Рђб T5FeedForward<br/>Рђб T5RelativeEmbedding"]
        
        VAE21["<b>vae2_1.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>class Wan2_1_VAE<br/>Рђб CausalConv3d<br/>Рђб Encoder3d<br/>Рђб Decoder3d<br/>Рђб ResidualBlock<br/>Рђб AttentionBlock"]
        
        VAE22["<b>vae2_2.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>class Wan2_2_VAE<br/>Рђб 4├Ќ16├Ќ16 compression<br/>Рђб For TI2V-5B"]
        
        TOKENIZERS["<b>tokenizers.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>HuggingfaceTokenizer"]
    end

    subgraph S2V_MODULES["­Ъјц wan/modules/s2v/"]
        S2V_INIT["<b>__init__.py</b>"]
        AUDIO_ENC["<b>audio_encoder.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>AudioEncoder<br/>Рђб wav2vec2 features<br/>Рђб Frame alignment"]
        MODEL_S2V["<b>model_s2v.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>WanModel_S2V<br/>Рђб Audio conditioning<br/>Рђб Motion latents"]
        MOTIONER["<b>motioner.py</b>"]
        AUDIO_UTILS["<b>audio_utils.py</b>"]
    end

    subgraph ANIMATE_MODULES["­ЪЋ║ wan/modules/animate/"]
        ANIM_INIT["<b>__init__.py</b>"]
        MODEL_ANIM["<b>model_animate.py</b>"]
        MOTION_ENC["<b>motion_encoder.py</b>"]
        FACE_BLOCKS["<b>face_blocks.py</b>"]
        CLIP_MOD["<b>clip.py</b>"]
        XLM["<b>xlm_roberta.py</b>"]
        
        subgraph PREPROCESS["preprocess/"]
            POSE2D["<b>pose2d.py</b>"]
            RETARGET["<b>retarget_pose.py</b>"]
            SAM_UTILS["<b>sam_utils.py</b>"]
            VIDEO_PRED["<b>video_predictor.py</b>"]
        end
    end

    subgraph DISTRIBUTED["­Ъїљ wan/distributed/"]
        DIST_INIT["<b>__init__.py</b>"]
        FSDP["<b>fsdp.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>shard_model()<br/>free_model()<br/>Рђб FSDP wrapping<br/>Рђб Mixed precision"]
        SEQ_PAR["<b>sequence_parallel.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>sp_attn_forward()<br/>sp_dit_forward()<br/>Рђб Head distribution"]
        ULYSSES["<b>ulysses.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>UlyssesAttention<br/>Рђб AllGather Q<br/>Рђб AllToAll KV"]
        DIST_UTIL["<b>util.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>init_distributed_group()<br/>get_world_size()"]
    end

    subgraph UTILS["­ЪћД wan/utils/"]
        UTILS_INIT["<b>__init__.py</b>"]
        FM_SOLVERS["<b>fm_solvers.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>FlowDPMSolverMultistepScheduler<br/>get_sampling_sigmas()<br/>retrieve_timesteps()"]
        FM_UNIPC["<b>fm_solvers_unipc.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>FlowUniPCMultistepScheduler"]
        PROMPT_EXT["<b>prompt_extend.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>DashScopePromptExpander<br/>QwenPromptExpander"]
        UTILS_FILE["<b>utils.py</b><br/>РћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂРћЂ<br/>save_video()<br/>merge_video_audio()"]
        SYS_PROMPT["<b>system_prompt.py</b>"]
    end

    %% Dependencies
    GENERATE --> INIT
    GENERATE --> CFG_INIT
    GENERATE --> PROMPT_EXT
    GENERATE --> UTILS_FILE
    
    INIT --> T2V
    INIT --> I2V
    INIT --> TI2V
    INIT --> S2V
    INIT --> ANIMATE
    
    T2V --> MODEL
    T2V --> T5
    T2V --> VAE21
    T2V --> FSDP
    T2V --> SEQ_PAR
    T2V --> FM_UNIPC
    T2V --> FM_SOLVERS
    
    I2V --> MODEL
    I2V --> T5
    I2V --> VAE21
    
    TI2V --> MODEL
    TI2V --> VAE22
    
    S2V --> MODEL_S2V
    S2V --> AUDIO_ENC
    S2V --> T5
    S2V --> VAE21
    
    ANIMATE --> MODEL_ANIM
    ANIMATE --> MOTION_ENC
    ANIMATE --> FACE_BLOCKS
    
    MODEL --> ATTENTION
    MODEL_S2V --> MODEL
    MODEL_ANIM --> MODEL
    
    T5 --> TOKENIZERS
    
    CFG_INIT --> CFG_SHARED
    CFG_T2V --> CFG_SHARED
    CFG_I2V --> CFG_SHARED
    CFG_TI2V --> CFG_SHARED
    CFG_S2V --> CFG_SHARED
    CFG_ANIM --> CFG_SHARED
    
    SEQ_PAR --> ULYSSES
    FSDP --> DIST_UTIL
    SEQ_PAR --> DIST_UTIL

    %% Styling
    classDef root fill:#2d2d44,stroke:#9d4edd,stroke-width:3px,color:#fff
    classDef package fill:#3c096c,stroke:#7b2cbf,stroke-width:2px,color:#fff
    classDef pipeline fill:#240046,stroke:#c77dff,stroke-width:2px,color:#fff
    classDef config fill:#5a189a,stroke:#e0aaff,stroke-width:1px,color:#fff
    classDef module fill:#10002b,stroke:#9d4edd,stroke-width:2px,color:#fff
    classDef dist fill:#1a472a,stroke:#4ade80,stroke-width:2px,color:#fff
    classDef utils fill:#4a1942,stroke:#f472b6,stroke-width:2px,color:#fff
    
    class GENERATE root
    class INIT package
    class T2V,I2V,TI2V,S2V,ANIMATE pipeline
    class CFG_INIT,CFG_SHARED,CFG_T2V,CFG_I2V,CFG_TI2V,CFG_S2V,CFG_ANIM config
    class MODEL,ATTENTION,T5,VAE21,VAE22,TOKENIZERS,MOD_INIT module
    class AUDIO_ENC,MODEL_S2V,MOTIONER,AUDIO_UTILS,S2V_INIT module
    class MODEL_ANIM,MOTION_ENC,FACE_BLOCKS,CLIP_MOD,XLM,ANIM_INIT module
    class POSE2D,RETARGET,SAM_UTILS,VIDEO_PRED module
    class FSDP,SEQ_PAR,ULYSSES,DIST_UTIL,DIST_INIT dist
    class FM_SOLVERS,FM_UNIPC,PROMPT_EXT,UTILS_FILE,SYS_PROMPT,UTILS_INIT utils

